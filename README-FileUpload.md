# ファイルアップロード機能の解説

このドキュメントでは、チャットアプリケーションにおけるファイルアップロード機能の実装について説明します。

## 機能の概要

ユーザーは会話中にファイルを添付でき、それらのファイルはサーバーにアップロードされて保存されます。アップロードされたファイルは会話の中で表示され、画像の場合はプレビューを見ることもできます。

## 主要コンポーネントと役割

ファイルアップロード機能は以下の主要なコンポーネントから構成されています：

### 1. FileUpload.tsx
ファイル選択のUIを提供するコンポーネントです。主な機能は：
- ドラッグ＆ドロップによるファイル選択
- クリックによるファイル選択ダイアログの表示
- 選択されたファイルのリスト表示
- ファイルの削除機能
- ファイルタイプとサイズのバリデーション

### 2. AttachmentViewer.tsx
アップロードされたファイルを表示するコンポーネントです。主な機能は：
- 添付ファイルのリスト表示
- 画像ファイルのプレビュー（クリックで展開）
- ダウンロードリンクの提供

### 3. ChatInput.tsx
ユーザー入力とファイルアップロードを管理するコンポーネントです。主な機能は：
- テキスト入力の処理
- ファイル選択UIの表示・非表示
- ファイルのアップロード処理
- メッセージとファイル情報のストアへの追加
- サーバーとの通信

### 4. ChatStore.ts
状態管理を担当するストアです。ファイルアップロードに関連する機能は：
- メッセージと添付ファイルの状態管理
- 添付ファイル情報の更新
- メッセージリストの更新

## データの流れ

ファイルアップロードの処理の流れは以下のとおりです：

1. ユーザーが `ChatInput` コンポーネントでファイル添付ボタンをクリック
2. `FileUpload` コンポーネントが表示され、ユーザーがファイルを選択
3. 選択されたファイルは `ChatInput` の状態 (`selectedFiles`) に保存される
4. ユーザーがメッセージを送信すると、以下の処理が行われる：
   a. 選択されたファイルから一時的な `FileAttachment` オブジェクトが作成される
   b. ユーザーメッセージと添付ファイル情報が `ChatStore` に追加される
   c. ファイルがサーバーにアップロードされる（APIリクエストの一部として）
   d. サーバーからの応答に含まれる実際のファイル情報で、一時的な添付ファイル情報が更新される
5. `AttachmentViewer` コンポーネントが添付ファイルを表示

## 主要な型定義

```typescript
// 添付ファイル情報の型定義
export type FileAttachment = {
  fileId?: string;      // サーバー側で生成されるID
  fileName: string;     // ファイル名
  fileSize: number;     // ファイルサイズ（バイト）
  fileType: string;     // MIMEタイプ
  fileUrl?: string;     // ファイルへのURL（サーバー側で生成）
  localId?: string;     // クライアント側で使用する一時ID
};

// メッセージの型定義
export type Message = {
  id?: string;
  role: 'user' | 'assistant' | 'system';
  content: string;
  attachments?: FileAttachment[]; // 添付ファイル情報
  // ...その他のプロパティ
};
```

## 最適化のポイント

1. **メモ化コンポーネント**: `AttachmentViewer` と `AttachmentItem` は `memo` でラップされており、添付ファイル情報が変わらない限り再レンダリングされません。

2. **条件付きレンダリング**: 添付ファイルがない場合や、画像でない場合はプレビューが表示されないなど、必要に応じて表示を最適化しています。

3. **添付ファイル状態の更新**: サーバーからの応答で添付ファイル情報を更新する際は、必要なメッセージのみを更新し、他のメッセージには影響を与えません。

## 初学者向けの実装ポイント

1. **ファイルのバリデーション**:
   - サポートされるファイル形式とサイズを定義
   - アップロード前のチェックを実装

2. **ドラッグ&ドロップの実装**:
   - `onDragEnter`、`onDragLeave`、`onDragOver`、`onDrop` イベントハンドラを使用
   - ドラッグ中の視覚的フィードバックの提供

3. **一時的なファイル情報と実際のファイル情報**:
   - ユーザー操作中は一時的なファイル情報を表示
   - サーバー処理完了後に実際のファイル情報（URL、ID）で更新

4. **エラーハンドリング**:
   - ファイルアップロード失敗時の処理
   - ユーザーへのフィードバックの提供

## おわりに

ファイルアップロード機能は複数のコンポーネントが連携して動作する複雑な機能ですが、責務を適切に分割することで保守性の高いコードになっています。また、パフォーマンス最適化のために、必要に応じてメモ化を活用しています。 